parameters:
- name: language
  type: string

- name: version
  type: string

- name: repoName
  type: string

- name: branchName
  type: string

- name: languageSpecificSteps
  type: step
  default:
    pwsh: |
      Write-Error "No language specific step is provided"

- name: cleanMetadataFile
  type: string

steps:
- template: set-up-for-generation.yml

- checkout: ${{ parameters.repoName }}
  displayName: 'checkout ${{ parameters.repoName }}'
  fetchDepth: 1
  persistCredentials: true

- pwsh: '$(scriptsDirectory)/create-branch.ps1'
  displayName: 'Create a branch in ${{ parameters.repoName }}'
  env:
    RepoDirectory: $(Build.SourcesDirectory)/${{ parameters.repoName }}
    BranchName: ${{ parameters.branchName }}

- pwsh: '$(scriptsDirectory)/run-typewriter.ps1'
  env:
    BuildConfiguration: $(buildConfiguration)
    OutputPath: output${{ parameters.language }}${{ parameters.version }}
    CleanMetadataFile: ${{ parameters.cleanMetadataFile }}
    TypewriterExecutable: $(typewriterExecutable)
    TypewriterDirectory: $(typewriterDirectory)
    Language: ${{ parameters.language }}
    Endpoint:  ${{ parameters.version }}
  displayName: 'Run Typewriter for ${{ parameters.language }} ${{ parameters.version }}'

- pwsh: '$(scriptsDirectory)/copy-dotnet-models.ps1'
  displayName: 'Update models'
  env:
    BuildConfiguration: $(buildConfiguration)
    OutputFullPath: $(typewriterDirectory)/output${{ parameters.language }}${{ parameters.version }}
    RepoModelsDir: $(Build.SourcesDirectory)/msgraph-beta-sdk-dotnet/src/Microsoft.Graph/Generated/

- template: dotnet-beta-validation.yml

- pwsh: '$(scriptsDirectory)/git-push-files.ps1'
  displayName: 'Git: push generated files'
  env:
    BranchName: ${{ parameters.branchName }}
  workingDirectory: '$(Build.SourcesDirectory)/msgraph-beta-sdk-dotnet'
