steps:
- pwsh: |
    $releaseJson = Invoke-RestMethod "https://api.github.com/repos/microsoft/kiota/releases/latest"
    $latestTag = $releaseJson.tag_name
    $platform = if ($IsLinux) { "linux-x64" } elseif ($IsMacOS) { "osx-x64" } else { "win-x64" }
    $asset = $releaseJson.assets | Where-Object { $_.name -match $platform } | Select-Object -First 1
    Write-Host "Downloading Kiota $latestTag"
    Write-Host "Asset URL: $($asset.browser_download_url)"
    $tmpDir = [System.IO.Path]::GetTempPath()
    $downloadPath = Join-Path $tmpDir "kiota_download"
    $extractPath = Join-Path $tmpDir "kiota_extract"
    New-Item -ItemType Directory -Force -Path $extractPath | Out-Null
    Invoke-WebRequest -Uri $asset.browser_download_url -OutFile $downloadPath
    if ($asset.name -match "\.zip$") {
      Expand-Archive -Path $downloadPath -DestinationPath $extractPath -Force
    } else {
      tar -xzf $downloadPath -C $extractPath
    }
    $kiotaBin = Get-ChildItem -Path $extractPath -Filter "kiota" -Recurse -File | Select-Object -First 1
    Write-Host "Found Kiota binary at: $($kiotaBin.FullName)"
    $stagingDir = "$(Build.ArtifactStagingDirectory)"
    New-Item -ItemType Directory -Force -Path $stagingDir | Out-Null
    Copy-Item -Path $kiotaBin.FullName -Destination (Join-Path $stagingDir "kiota")
  displayName: 'Download latest Kiota from GitHub'
