steps:
- template: set-up-for-generation.yml

- checkout: msgraph-sdk-php
  displayName: checkout php
  fetchDepth: 1
  persistCredentials: true

- pwsh: |
    # Example directories are:
    # src/Model (types in microsoft.graph namespace)
    # src/CallRecords/Model (types in microsoft.graph.callRecords namespace)
    Get-ChildItem ./src/ -Exclude Beta,Core,Exception,Http -Directory | Remove-Item -Force -Recurse
    Write-Host "Removed the existing generated files in the repo at $modelDir." -ForegroundColor Green

    # removes all models under src/Beta
    Get-ChildItem ./src/ -Include Beta -Directory -Recurse | Remove-Item -Recurse -Force
    Write-Host "Removed the existing generated files for Beta in the repo at $($env:REPODIR)." -ForegroundColor Green
  displayName: 'Remove generated files from the repo'
  workingDirectory: $(Build.SourcesDirectory)/msgraph-sdk-php 

- pwsh: '$(Build.SourcesDirectory)/MSGraph-SDK-Code-Generator/scripts/run-typewriter.ps1'
  env:
    BuildConfiguration: $(buildConfiguration)
    OutputPath: $(outputPHPV1)
    CleanMetadataFile: $(cleanMetadataFileV1)
    TypewriterExecutable: $(typewriterExecutable)
    TypewriterDirectory: $(typewriterDirectory)
    Language: 'PHP'
  displayName: 'Run Typewriter for PHP V1'

- pwsh: '$(Build.SourcesDirectory)/MSGraph-SDK-Code-Generator/scripts/run-typewriter.ps1'
  env:
    BuildConfiguration: $(buildConfiguration)
    OutputPath: $(outputPHPBeta)
    CleanMetadataFile: $(cleanMetadataFileBeta)
    TypewriterExecutable: $(typewriterExecutable)
    TypewriterDirectory: $(typewriterDirectory)
    Language: 'PHP'
    Endpoint: 'beta'
  displayName: 'Run Typewriter for PHP Beta'

- pwsh: '$(Build.SourcesDirectory)/MSGraph-SDK-Code-Generator/scripts/create-branch.ps1'
  displayName: 'Create a branch'
  env:
    RepoDirectory: $(Build.SourcesDirectory)/msgraph-sdk-php
    BranchName: $(v1Branch)

- pwsh: '$(Build.SourcesDirectory)/MSGraph-SDK-Code-Generator/scripts/copy-php-models.ps1'
  displayName: 'Update models'
  env:
    BuildConfiguration: $(buildConfiguration)
    OutputFullPathV1: $(typewriterDirectory)/$(outputPHPV1)
    OutputFullPathBeta: $(typewriterDirectory)/$(outputPHPBeta)
    RepoModelsDirV1: $(Build.SourcesDirectory)/msgraph-sdk-php/src/
    RepoModelsDirBeta: $(Build.SourcesDirectory)/msgraph-sdk-php/src/Beta

# TODO run PHP tests

- pwsh: '$(Build.SourcesDirectory)/MSGraph-SDK-Code-Generator/scripts/git-push-files.ps1'
  displayName: 'Git: push generated files'
  env:
    BranchName: $(v1Branch)
  workingDirectory: '$(Build.SourcesDirectory)/msgraph-sdk-php'
