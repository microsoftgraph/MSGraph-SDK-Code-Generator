parameters:
- name: cleanMetadataFolder
  type: string

steps:
- template: /.azure-pipelines/generation-templates/set-user-config.yml@self
- template: /.azure-pipelines/generation-templates/use-dotnet-sdk.yml@self
  parameters:
    version: "10.x"

- bash: |
    KIOTA_BIN=$(find "$(kiotaDirectory)" -name "kiota" -type f | head -1)
    if [ -z "$KIOTA_BIN" ]; then
      echo "ERROR: kiota binary not found under $(kiotaDirectory)"
      echo "Directory contents:"
      ls -laR "$(kiotaDirectory)" || echo "Directory does not exist"
      exit 1
    fi
    chmod +x "$KIOTA_BIN"
    echo "Kiota binary ready at: $KIOTA_BIN"
    echo "##vso[task.setvariable variable=kiotaExecutable]$KIOTA_BIN"
  displayName: 'Make Kiota executable'

# checkout metadata repo if capture and clean step is skipped
- checkout: msgraph-metadata
  displayName: checkout metadata
  fetchDepth: 1
  persistCredentials: true
  submodules: recursive
  condition: or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true))

- pwsh: |
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/v1.0/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi/
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/beta/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi/
  displayName: Move metadata to expected location
  condition: or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true))
