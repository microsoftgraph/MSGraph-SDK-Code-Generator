parameters:
  - name: cleanMetadataFolder
    type: string
  - name: downloadSteps
    type: stepList
    default:
    - pwsh: |
        Write-Error "No download step is provided"
  - name: isCopilotGeneration
    type: boolean

steps:
- template: set-user-config.yml
- template: use-dotnet-sdk.yml
  parameters:
    version: "9.x" #kiota uses a net9 target

- ${{ parameters.downloadSteps }}

# checkout metadata repo if capture and clean step is skipped
- checkout: msgraph-metadata
  displayName: checkout metadata
  fetchDepth: 1
  persistCredentials: true
  submodules: recursive
  condition: or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true))

- checkout: Agents-M365Copilot
  displayName: checkout Agents-M365Copilot to get the OpenAPI file
  fetchDepth: 1
  persistCredentials: true
  submodules: recursive
  condition: ${{ eq(parameters.isCopilotGeneration, true) }}

- pwsh: |
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi
    Copy-Item -Path $(Build.SourcesDirectory)/Agents-M365Copilot/openapi/ccs-beta-review-openapi.yml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi/openapi.yaml
    Copy-Item -Path $(Build.SourcesDirectory)/Agents-M365Copilot/openapi/ccs-beta-review-openapi.yml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi/openapi.yaml
  displayName: Move Custom CCS metadata to expected location
  condition: ${{ eq(parameters.isCopilotGeneration, true) }}


- pwsh: |
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/v1.0/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi/
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/beta/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi/
  displayName: Move metadata to expected location
  condition: and(or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true)), ${{ eq(parameters.isCopilotGeneration, false) }})

# if capture and clean step is not skipped
# then download the artifact from capture and clean steps
# follow the same folder structure as msgraph-metadata repo
# so that metadata reference path is always the same
- task: DownloadBuildArtifacts@0
  inputs:
    buildType: 'current'
    downloadType: 'single'
    artifactName: ${{ parameters.cleanMetadataFolder }}
    downloadPath: '$(Build.SourcesDirectory)/msgraph-metadata'
  condition: and(eq(variables.skipMetadataCaptureAndClean, false), eq(variables.skipOpenApiCaptureAndClean, false), ${{ eq(parameters.isCopilotGeneration, false) }})
  displayName: Downloading metadata from artifacts
