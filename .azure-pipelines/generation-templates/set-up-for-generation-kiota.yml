parameters:
- name: cleanMetadataFolder
  type: string

steps:
- template: /.azure-pipelines/generation-templates/set-user-config.yml@self
- template: /.azure-pipelines/generation-templates/use-dotnet-sdk.yml@self
  parameters:
    version: "10.x"

- pwsh: |
    $kiotaBin = Get-ChildItem -Path "$(kiotaDirectory)" -Recurse -File | Where-Object { $_.BaseName -eq "kiota" } | Select-Object -First 1
    if (-not $kiotaBin) {
      Write-Error "Kiota binary not found under $(kiotaDirectory)"
      Get-ChildItem "$(kiotaDirectory)" -Recurse -ErrorAction SilentlyContinue | Select-Object FullName
      exit 1
    }
    chmod +x $kiotaBin.FullName
    Write-Host "Kiota binary ready at: $($kiotaBin.FullName)"
    Write-Host "##vso[task.setvariable variable=kiotaExecutable]$($kiotaBin.FullName)"
  displayName: 'Make Kiota executable'

# checkout metadata repo if capture and clean step is skipped
- checkout: msgraph-metadata
  displayName: checkout metadata
  fetchDepth: 1
  persistCredentials: true
  submodules: recursive
  condition: or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true))

- pwsh: |
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi
    md $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/v1.0/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_v10_openapi/
    Move-Item -Path $(Build.SourcesDirectory)/msgraph-metadata/openapi/beta/openapi.yaml -Destination $(Build.SourcesDirectory)/msgraph-metadata/clean_beta_openapi/
  displayName: Move metadata to expected location
  condition: or(eq(variables.skipMetadataCaptureAndClean, true), eq(variables.skipOpenApiCaptureAndClean, true))
